# Pitaya-Core

## About Pitaya-Core
Pitaya-Core 是 Pitaya（去中心社交媒体） 的Model、Controller层。提供功能：  

1. 创建账户
2. 发布日志（推文）
   - 热点日志 (*Not Implemented yet*)
   - 日志归档 
   - 图片日志
   - 视频日志 (*Not Implemented yet*)
3. 同步日志（推文）
4. 日志（推文）互动
5. 关注用户
6. 创建聊天室(*Not planned yet*)

# How it works

## 依赖
Pitaya-Core依赖orbit-db(去中心数据库)。

## 1. 创建账户
**传统的社交平台创建账户流程**

用户上传注册信息到平台运营方，运营方将数据存储在远程服务器上
```
 --------                         -----------------
|        |  post register info   |                 |
|  user  | ====================> | remote database |
|        |                       |                 |
 --------                         -----------------
```
**Pitaya创建账户流程**

用户注册后信息只在本地保存
```
 --------                                ----------------
|        |  save register info locally  |                |
|  user  | ===========================> | local database |
|        |                              |                |
 --------                                ----------------
```
### 比较
| 传统社交平台 | Pitaya |
|------------|--------|
|用户数据统一在云端存储|用户数据只在用户本地存储|
|大多数情况下用户不需要担心数据丢失|用户需要妥善保存自己的数据|
|运营方可以控制所有用户数据|用户数据只有用户自己可以控制|
|数据分发、推广由运营方完成|用户需要自己分发数据|

*用户如何分发数据将在发布日志章节详细说明*

### Pitaya 用户数据库结构
```Javascript
//user
{
    username:'用户名',
    bio:'',
    id:'数据库hash值',
    followDbId:'记录我关注的人的数据库hash值'
    postDbId:'记录我的日志的数据库hash值'
}
//posts
{
    count:0 //发布日志数量
}
//followings
{
    count:0 //关注的人数量
}
```
用户创建后，其他人（包括自己）可以通过访问用户数据库，获取到该用户的关注列表与日志列表。

只有用户数据库的创建者可以修改数据库中的值。因此也只有数据库的创建者可以“登录”该用户。

## 2.发布日志(推文)
**传统社交平台发布日志流程**

用户将日志（推文）上传到远程服务器，服务器统一向其他用户分发
```
 ------           ---------------                           ------- -------
|      |  post   |               | publish to other user   | user1 | user3 |
| user | ======> | remote server | ======================>  ------- -------
|      |         |               |                         | user2 | ..... |
 ------           ---------------                           ------- -------
```
**Pitaya发布日志流程**

用户将日志(推文)保存到本地数据库中，并且定时向其他对等节点（连接到Pitaya网络的用户）发送该用户的日志数据库地址。其他节点获取到地址后可以选择从地址中同步数据库，来获取日志（推文）
```
 ------           ----------------                           ------- -------
|      |  post   |                | publish to other user   | user1 | user3 |
| user | ======> | local database | ======================>  ------- -------
|      |         |                |                         | user2 | ..... |
 ------           ----------------                           ------- -------
```
### *热点日志*
由于用户的日志数据库体积可能很大，其他节点同步会消耗大量时间，为了提高数据同步效率，Pitaya-Core会将用户日志数据库分为*热点日志库*与*归档日志库*。热点日志库只记录最新发布的20（数量暂定）条日志；归档日志库会记录用户的所有日志。用户节点只定时发布热点日志库的地址。其他用户想要访问该用户的所有日志时，需要从该用户的用户数据库中获取到归档日志库的地址进行同步。

### 日志结构
```Javascript
//post
{
    username:'发布者用户名',
    ownerId:'发布者的用户数据库id',
    timestamp:'创建时间',
    commentAddr:'评论数据库id', //日志互动章节会详细展开
    description:'日志内容',
    mediaUrl:'日志媒体内容', //图片或其他媒体的ipfs地址
}
```

## 3.同步日志(推文)
**传统社交平台同步日志流程**

用户请求远程服务器获得已关注的用户新上传的日志(推文)
```
 ------                    ---------------
|      |  request news    |               |
| user | <==============> | remote server |
|      |                  |               |
 ------                    ---------------
```
**Pitaya同步日志流程**
用户向网络中的其他对等节点同步已关注的日志数据库id（即使数据库的创建者没有连接在网络中，用户依然可能从其他与数据库创建者同步过的节点中同步数据）
```
 ------                              ------- -------
|      | =========================> | user1 | user3 |
| user |  fetch followed database    ------- -------
|      | =========================> | user2 | ..... |
 ------                              ------- -------
```
### Timeline & News

1. Timeline
> Timeline只显示用户关注的数据库中同步到的日志
2. News
> News中显示当前网络中由其他节点定时发布的数据库中的日志

## 4. 日志互动







